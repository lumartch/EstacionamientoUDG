<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
        <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
        <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
        <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
        <link rel="shortcut icon" type="image/x-icon" href="https://www.mexicoescultura.com/galerias/espacios/principal/udg.jpg" />
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.2/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.2/mapbox-gl.css' rel='stylesheet' />
        <title>Estacionamiento UDG</title>
        <script>
            // Función de carga a la página, sirve como Delay para el Splash Screen
            window.onload=function(){
                setTimeout(function(){ 
                    document.getElementById('splash').style.display= "block";
                    //Carga la página dependiendo de los datos en el LocalStorage
                    if (localStorage.getItem('usuario') == null) {
                        document.querySelector('#myNavigator').pushPage('index.html');
                    } else {
                        document.querySelector('#myNavigator').pushPage('maps.html');
                    }
                },3500)
            }
            // Función para iniciar sesión
            function login(){
                codigo = document.getElementById("code").value;
                nip = document.getElementById("pass").value;
                if(codigo == "" || nip == ""){
                    ons.notification.alert("Llene los datos correspondientes para el inicio de sesión.");
                    return;
                }
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function(){
                if(xhttp.readyState == 4 && this.status == 200){
                    var cadena = xhttp.responseText;
                    var array = cadena.split(',');
                    if(array[0] == 'A'){  
                        code = array[1];
                        name = array[2];
                        career = array[4];
                        document.querySelector('#myNavigator').pushPage('maps.html');
                        var dialog = document.getElementById('altaDialog');
                        if (dialog) {
                            dialog.show();
                        } else {
                            ons.createElement('alert-dialog.html', { append: true })
                            .then(function(dialog) {
                                dialog.show();
                            });
                        }
                    }
                    else {
                        ons.notification.alert("Usuario o contraseña erronea. Intente de nuevo.");
                    }
                }
                };
                xhttp.open("GET", "http://dcc.000webhostapp.com/2018/datosudeg.php?codigo="+ codigo + "&nip=" + nip, true);
                xhttp.send();
            }
            // Función interfaz para dar de alta a un usuario nuevo
            function altaNuevo(){
                var c = document.getElementById("inCode").innerHTML;
                var n = document.getElementById("inName").value;
                var p = document.getElementById("inPlacas").value;
                var t = document.getElementById("inTel").value;
                var pass = document.getElementById("inPass").value;
                if(c == "" || n == "" || p == "" || t == "" || pass == ""){
                    ons.notification.alert("Llene los datos correspondientes para dar de alta al usuario.");
                    return;
                }
                if(t < 1000000000 || t > 9999999999){
                    ons.notification.alert("El formato del Teléfono es el incorrecto, deben ser 10 números.");
                    return;
                }
                alta(c, n, p, t, pass);
            }
            // Función interfaz para dar de alta a un usuario UDG
            function altaUDG(placas, telefono){
                if(placas == "" || telefono == "" ){
                    ons.notification.alert("Llene los datos correspondientes para dar de alta el coche.");
                    return;
                }
                if(telefono < 1000000000 || telefono > 9999999999){
                    ons.notification.alert("El formato del Teléfono es el incorrecto, deben ser 10 números.");
                    return;
                }
                var pass = 322;
                // Código para ocultar el Alert de Alta UDG
                document.getElementById('altaDialog').hide();
                alta(code, name, placas, telefono, pass);
            }

            function alta(c, n, p, t, pass){
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function(){
                if(xhttp.readyState == 4 && this.status == 200){
                    var cadena = xhttp.responseText;
                    console.log(cadena);
                    var array = cadena.split(',');
                    if(array[0] == 1){  
                        // Datos ingresados al Servidor
                        //console.log(array[1]);
                        // Datos guardados en el localStorage 
                        localStorage.setItem('codigo', c);
                        localStorage.setItem('usuario', n);
                        localStorage.setItem('placas', p);
                        localStorage.setItem('telefono', t);
                        ons.notification.alert("El coche fue registrado correctamente, puede pasar al Estacionamiento.");
                        document.querySelector('#myNavigator').pushPage('maps.html');
                    }
                    else {
                        ons.notification.alert("ERROR.");
                    }
                }
                };
                xhttp.open("GET", "http://cuceimobile.tech/Escuela/altaU.php?codigo="+ c + "&nombre=" + n + "&placas=" + p +"&telefono=" + t + "&password=" + pass, true);
                xhttp.send();
            }

            // Código para ocultar el Alert de Alta UDG
            var hideAlertDialog = function() {
            document.getElementById('altaDialog').hide();
            };

            // Código para entrar al index de nuevo y eliminar los datos locales
            function pushIndex(){
                document.querySelector('#myNavigator').pushPage('index.html');
                localStorage.clear();
            }
        </script>
        <style>
            .toolbar {
                background-color:rgb(26, 26, 26);
            }
            .card{
                background-color:rgb(26, 26, 26);;
                color:lightcyan;
            }
            .list-header{
                background-color: rgb(26, 26, 26);
                color:lightcyan;
            }
            .list-item{
                background-color: rgb(51, 51, 51);
                color:lightcyan;
            }
            .button{
                background-color: rgb(13, 13, 13);
                color:lightcyan;
            }
            h1{
                color:lightcyan;
            }
            .white{
                color:lightcyan;
            }
            .back-button{
                color:white;
                background-image: white;
            }
            #code { color:white; }
            #pass { color:white; }
            #inCode { color:white; }
            #inName { color:white; }
            #inPlacas { color:white; }
            #inPl { color: white; }
            #inTel { color:white; }
            #inPass { color:white; }
            #alTitle {background-color: rgb(26, 26, 26);
                color:lightcyan;}
        </style>
    </head>
    <body>
        <ons-navigator swipeable id="myNavigator" page="splash.html" animation="slide" ></ons-navigator>
        <template id="splash.html">
            <ons-page id="splash" >
                <div class="background" style="background-color:black;"></div>
                <div class="content">
                <!--<ons-card>-->
                    <center>
                    <img src="https://www.keybps.com/wp-content/uploads/2018/02/Estacionamiento.png" height="200" width="200"/>
                    <br>
                    <h1><i style="color: cyan;">Park App</i></h1>
                    </center>
                <!--</ons-card>
                <ons-card>-->
                    <center>
                    <h3><b style="color: cyan;">Bienvenido usuario, registre su coche para <br>pasar al estacionamiento de CUCEI.</b></h3>
                    </center>
                <!--</ons-card>-->
                </div>
            </ons-page>
        </template>

        <template id="index.html">
            <ons-page id="index">
            <div class="background" style="background-color:black;"></div>
            <div class="content">
                <ons-toolbar>
                    <div class="center"><ons-icon size="20px" icon="md-home" class="white"></ons-icon>  <label class="white">Universidad de Guadalajara</label></div>
                </ons-toolbar>
                <ons-card style="margin-top: 1.5cm;">
                    <center>
                        <h1>Estacionamiento CUCEI</h1>
                        <img src="http://cdn.onlinewebfonts.com/svg/img_569117.png" height="200" width="200">
                    </center>
                </ons-card>
                <ons-card>
                    <center>
                        <ons-input input-id="code" placeholder="Código" type="text" modifier="underbar"></ons-input>
                        <br><br>
                        <ons-input input-id="pass" placeholder="NIP" type="password" modifier="underbar"></ons-input>
                        <br><br>
                        <ons-button id="enviarButton" modifier="material" onclick="login()">Entrar</ons-button>
                        <br><br>
                        <label onclick="document.querySelector('#myNavigator').pushPage('newUser.html');"><h4><b>Nuevo usuario</b></h4></label>
                    </center>
                </ons-card>
            </div>
            </ons-page>
        </template>

        <template id="alert-dialog.html">
            <ons-alert-dialog id="altaDialog" modifier="rowfooter" cancelable animation="default">
                <div id="alTitle" class="alert-dialog-title" ><b><h3>Alta de coche</h3></b></div>
                <div class="alert-dialog-content" style="background-color: rgb(26, 26, 26); color:white;">
                    <center>HOLA USUARIO<br><i><label id="nm"></label></i></center>
                    <script>
                        document.getElementById("nm").innerHTML = name;   
                    </script>
                    <br>
                    <ons-input input-id="inPl" placeholder="Placas" type="text" modifier="underbar" style="color: white;"></ons-input>
                    <ons-input input-id="inTel" placeholder="Teléfono" type="number" modifier="underbar" style="color:white;" onkeypress="return event.charCode >= 48 && event.charCode <= 57"></ons-input>
                </div>
                <div class="alert-dialog-footer" style="background-color: rgb(13, 13, 13); color:white;">
                    <ons-alert-dialog-button onclick="altaUDG(document.getElementById('inPl').value, document.getElementById('inTel').value)" style="color:white;">Alta</ons-alert-dialog-button>
                    <ons-alert-dialog-button onclick="hideAlertDialog()" style="color:white;">Cancelar</ons-alert-dialog-button>
                </div>
            </ons-alert-dialog>
        </template>

        <template id="newUser.html">
            <ons-page id="newUser">
                <div class="background" style="background-color:black;"></div>
                <div class="content">
                    <ons-toolbar>
                        <div class="left"><ons-back-button id="rNew">Regresar</ons-back-button></div>
                        <div class="center"><ons-icon size="20px" icon="fa-file" class="white"></ons-icon><label class="white">  Registro de usuario nuevo</label></div>
                    </ons-toolbar>
                    <ons-card style="margin-top: 1.5cm;">
                        <p class="intro">
                            <center>
                            <ons-list-header>Ingrese los datos correspondientes</ons-list-header>
                            <ons-list-item>
                                <label class="white">Código: </label> <label id="inCode" class="white"></label>
                                <script>
                                    var min = Math.ceil(1000);
                                    var max = Math.floor(5000);
                                    var res =  Math.floor(Math.random() * (max - min + 1)) + min;
                                    document.getElementById("inCode").innerHTML = res.toString();
                                </script>
                            </ons-list-item>
                            <ons-list-item>
                                    <ons-input input-id="inName" placeholder="Nombre" type="text" modifier="underbar" ></ons-input>
                                </ons-list-item>
                            <ons-list-item>
                                <ons-input input-id="inPlacas" placeholder="Placas" type="text" modifier="underbar"></ons-input>
                            </ons-list-item>
                            <ons-list-item>
                                <ons-input input-id="inTel" placeholder="Teléfono" type="number" modifier="underbar" onkeypress="return event.charCode >= 48 && event.charCode <= 57"></ons-input>
                            </ons-list-item>
                            <ons-list-item>
                                    <ons-input input-id="inPass" placeholder="Contraseña/NIP" type="password" modifier="underbar"></ons-input>
                            </ons-list-item>
                            <br><br>
                            <ons-button id="altaButton" modifier="material" onclick="altaNuevo()">Alta</ons-button>
                            </center>
                        </p>
                    </ons-card>
                </div>
            </ons-page>
            
        </template>

        <template id="maps.html">
            <ons-page id="maps" >
                <div class="background" style="background-color:black;"></div>
                <div class="content">
                    <ons-toolbar>
                        <div class="left"><ons-back-button onclick="pushIndex()">Salir</ons-back-button></div>
                        <div class="center"><ons-icon size="20px" icon="fa-car" class="white"></ons-icon><label class="white">  Mapa del estacionamiento</label></div>
                    </ons-toolbar>
                    <ons-card style="margin-top: 1.5cm;">
                        <center>HOLA USUARIO<br><i><label id="nameMap"></label></i></center>
                        <script>
                            document.getElementById("nameMap").innerHTML = localStorage.getItem('usuario');   
                        </script>
                    </ons-card>
                    <div class="mapouter">
                        <div class="gmap_canvas">
                                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d933.3412607245299!2d-103.32553151192371!3d20.654722554036248!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8428b23abb6f2e57%3A0xc3806926efc93100!2sOl%C3%ADmpica%2C%2044430%20Guadalajara%2C%20Jalisco!5e0!3m2!1sen!2smx!4v1570555170670!5m2!1sen!2smx" width="500" height="500" frameborder="0" style="border:0;" >
                                </iframe>
                        </div>
                        <style>
                        .mapouter{
                            position:relative;
                            text-align:right;
                            height:500px;
                            width:600px;
                            }
                        .gmap_canvas {
                            overflow:hidden;
                            background:none!important;
                            height:500px;
                            width:400px;
                            }
                        </style>
                    </div>
                </div>  
            </ons-page>
        </template>
        
        <script type="text/javascript" src="cordova.js"></script>
    </body>
</html>
